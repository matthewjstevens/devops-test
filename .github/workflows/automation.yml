name: automation

on:
  push:
    branches: ["main","dockerfile.main"]

jobs:

  build:

    runs-on: self-hosted

    defaults:
      run:
        shell: bash

    steps:

      # Checkout repo
      - uses: actions/checkout@v4
        with:
          repository: matthewjstevens/devops-test
          ref: dockerfile.main

      - uses: actions/setup-go@v5
        with:
          go-version: '^1.23.1' #The Go version to download (if necessary) and use.
      - run: go version
     
      - name: Commit SHA slug
        id: slug
        run: echo "::set-output name=sha8::$(echo ${GITHUB_SHA} | cut -c1-8)"

      # Run test suite
      - name: run tests
        run: |
          go test
      #  working-directory: path here
      - name: debug
        run: |
          ls -al
        working-directory: ${{ github.workspace }}

      # Build docker image
      - name: build docker image
        run: docker build . -t ghcr.io/matthewjstevens/${{ steps.slug.outputs.sha8 }}:latest
        working-directory: ${{ github.workspace }}

      # Login handler
      - name: log into docker container reg
        run: docker login ghcr.io -u ${{ secrets.docker_login }} --password ${{ secrets.docker_password }}

      # Push to container
      - name: push container to container registry
        run: docker push ghcr.io/matthewjstevens/${{ steps.slug.outputs.sha8 }}:latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 

      #
      - uses: cschleiden/replace-tokens@v1
        with:
          tokenPrefix: _ # not required
          tokenSuffix: _ # not required
          files: '["kubernetes/.yaml"]'
        env:
          DOCKER_REPOSITORY: ghcr.io/matthewjstevens/${{ steps.slug.outputs.sha8 }}
          IMAGE_TAG: latest
    
     # Authorisation with config file
     - uses: actions-hub/kubectl@master
       env:
         KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
       with:
         args: apply -f manifests/kubernetes.yml
